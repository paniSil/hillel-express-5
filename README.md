# ДЗ #3 Express.js

Приклад розробки сервера з використанням Express.js.
В поточну версію додано використання cookies, авторизацію за допомогою jwt та використання статичних файлів.
## 1. Технології:

- Node.js
- Express.js
- PUG
- EJS
- Bootstrap
- cookie-parser
- jsonwebtoken
- bcrypt

## 2. Основа сервера

Попередні версії сервера доступні за посиланнями https://github.com/paniSil/hillel-express-2 та https://github.com/paniSil/hillel-express-3

## 3. Використані Middleware

### 3.1. logRequests (src/middleware/logRequests.mjs)

Записує інформацію про кожен вхідний HTTP-запит (час, метод, URL) у консоль сервера. Допомагає у моніторингу та дебагінгу. Використовується глобально до всіх запитів (app.use(logRequests))

### 3.2. cookie-parser (встановлюється в server.mjs)

Парсить HTTP-заголовки Cookie у об'єкт req.cookies, надаючи доступ до cookies. Використовується глобально (app.use(cookieParser())).

### 3.3. JWT Authentication Middleware (protect) (src/middleware/authHandler.mjs)

Перевірка автентифікації користувача.

- Отримує JWT з httpOnly cookie (jwt).
- Верифікує токен за допомогою секретного ключа (JWT_SECRET).
- Декодовані дані користувача (ID, email, роль) додаються до об'єкта req.user.
- Якщо токен відсутній або недійсний, повертає 401 Unauthorized або 403 Forbidden.
- Застосовується до захищених маршрутів (наприклад, /users, /articles) у src/routes/index.mjs.

### 3.4. Authorization Middleware (authorize) (src/middleware/authHandler.mjs)

Перевірки прав доступу користувача (авторизації) на основі його ролі.

- Працює після мідлвару protect, оскільки покладається на наявність req.user.
- Приймає масив дозволених ролей.
- Якщо роль користувача (з req.user.role) не відповідає дозволеним ролям, повертає 403 Forbidden.
- Застосовується до маршрутів, що вимагають специфічних прав доступу (наприклад, /articles, де може вимагатися роль 'admin').

### 3.5 Валідатори (validateUserBody, validateParamsUserId, validateArticleBody, validateParamsArticleId) (src/validators/articleValidation.mjs, src/validators/userValidation.mjs,)

Виконують валідацію вхідних даних (тіла запиту або параметрів URL) за допомогою бібліотек Joi (для визначення схеми валідації) та celebrate. Якщо дані не проходять валідацію, повертає 400 Bad Request з текстовим описом помилки.

### 3.6 Обробники помилок (notFoundHandler, errorHandler) (src/middleware/errorHandler.mjs)

- notFoundHandler: Обробляє запити до неіснуючих маршрутів, повертаючи 404 Not Found.
- errorHandler: Глобальний обробник помилок, який перехоплює всі необроблені помилки в додатку. Він спеціально обробляє помилки celebrate, повертаючи 400 Bad Request з повідомленням про валідацію. Для інших помилок повертає 500 Internal Server Error.

Застосовуються глобаль в server.mjs.

## 4. Реалізовані маршрути

Маршрути реалізовані за домопогоду Express Router

### 4.1 Кореневий маршрут ('/')

Базовий маршрут для перевірки доступності сервера (дозволяє метод GET).

### 4.2 Користувачі ('/users')

Дозволено:

- отримати список користувачів (GET)
- додати нового користувача (POST)
- отримати інфо користувача за ID ('/users/:userId' - GET)
- оновити користувача за ID ('/users/:userId' - PUT)
- видалити користувача за ID ('/users/:userId' - DELETE)

### 4.3 Статті ('/articles')

- отримати всі статті (GET)
- додати нову статтю (POST)
- отримати статтю за ID ('/articles/:articleId' - GET)
- оновити статтю за ID ('/articles/:articleId' - PUT)
- видалити статтю за ID ('/articles/:articleId' - DELETE)

### 4.4. Авторизація (/auth)

#### /auth/register (GET, POST):

- відображення сторінки реєстрації (GET)
- реєстрація нового користувача з хешуванням пароля за допомогою bcrypt (POSt).

#### /auth/login (GET, POST):

- відображення сторінки входу (GET)
- аутентифікація користувача, генерація JWT та його збереження в httpOnly cookie (POST)

#### /auth/logout

- Видалення JWT cookie, завершуючи сесію користувача (POST)

### 4.5. Управління темою (/theme)

- Відображення сторінки налаштувань теми, показуючи поточну тему (GET)
- Збереження обраної користувачем теми в httpOnly cookie. Після збереження перенаправляє користувача назад на сторінку налаштувань теми, щоб оновити вигляд (POST)

### 4.6 Управління cookies

Маршрути /set-cookie (GET) та /get-cookie (GET) використовуються для встановлення та отримання cookies.

## 5. Використані шаблонізатори

У цьому проєкті демонструється можливість комбінованого використання різних шаблонних рушіїв в одному Express.js застосунку.

### 5.1. PUG для сторінок користувачів та індексу

PUG використовується для рендерингу сторінок, що стосуються управління користувачами:

- сторінка списку усіх користувачів (/users)
- сторінка з інформацією про кожного окремого користувача (/users/:id).

А також для рендеру головної сторінки і її інтерфейсу.

### 5.2. EJS для сторіонок статей

EJS застосовується для візуалізації сторінок, пов'язаних зі статтями:

- сторінка списку всіх статей (/articles).
- сторінка окремої статті (/articles/:id)

## 6. Статичні файли

Обслуговування статичних файлів з папки public за допомогою express.static('public'), для підключення CSS-файлів (/styles.css), зображення та іконок.

### 6.1 Favicon

Файл favicon.png в папці public і підключений до шаблонізаторів для відображення фавікону на кожній сторінці.

## 7. Робота з Cookies

Реалізовано функціональність збереження налаштувань користувача, зокрема обраної теми оформлення сайту, за допомогою HTTP cookies.

- cookie-parser: Використовується для парсингу та маніпуляції cookies.
- Збереження теми: Обрана тема зберігається в cookie з назвою theme.
- Доступні light і dark теми.

## 8. Інтеграція JWT

Система аутентифікації побудована на JSON Web Tokens (JWT) для безпечної та безстанової авторизації.

- Реєстрація: Користувачі можуть зареєструватися, їхні паролі хешуються за допомогою bcrypt перед збереженням. Нові користувачі за замовчуванням отримують роль 'admin' (тимчасове рішення)
- Вхід: Після успішного входу користувачу видається JWT, який зберігається в httpOnly cookie.
- Захист маршрутів: Спеціальний мідлвар (protect) перевіряє наявність та валідність цього JWT для доступу до захищених ресурсів.
- Авторизація за ролями: Додатковий мідлвар (authorize) дозволяє обмежувати доступ до певних маршрутів лише для користувачів з визначеними ролями, які також зберігаються в JWT.
- На захищенних сторінках додано форму для виходу користувача, після чого налаштовано редірекшн на головну сторінку.

## 9. Тестування vitest

Для тестування попередніх версій сервера використовувався vitest. В поточній версії тести не використовуються.

## 9. Налаштування репозиторію і запуск сервера:

### 9.1. Завантажуємо репозиторій та розгортаємо проект

`npm install`

або

`yarn`

_yarn повинен бути встановлений глобально, це можна зробити командой:_

`npm i -g yarn`

### 9.2. Запускаємо сервер

`npm start

# або

node src/server.mjs`

### 9.3. Перевіряємо роботу сервера

Сервер буде запущено на порту 3000. Ви побачите повідомлення у консолі: Сервер запущений за адресою http://localhost:3000.

### 9.4. Припинення роботи сервера

Необхідно повернутися до терміналу і натиснути комбінацію клавіш Ctrl + C
